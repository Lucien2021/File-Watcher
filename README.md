# 文件监控自动同步工具

一个用于嵌入式开发的 Windows 系统托盘应用，可以实时监控指定的文件，当文件更新时自动复制到对应的测试目录。

## 功能特点

- ✅ 实时监控指定文件的变化
- ✅ 自动复制文件到目标目录（等待文件写入完成，确保文件完整）
- ✅ 支持多个文件-目录映射
- ✅ **项目分组管理**：自动识别项目，支持选择性监控
- ✅ 系统托盘后台运行
- ✅ 复制后自动打开目标目录
- ✅ 图形化配置界面
- ✅ 日志记录所有操作
- ✅ 支持直接粘贴 Windows 路径（自动处理反斜杠）

## 环境要求

- **Python 3.8 或更高版本**
- **Windows 操作系统**
- 网络连接（首次安装依赖时需要）

## 快速开始

### 第一步：检查 Python 环境

1. 打开命令提示符（CMD）或 PowerShell
2. 输入以下命令检查 Python 是否已安装：

```bash
python --version
```

如果显示类似 `Python 3.8.x` 或更高版本，说明 Python 已安装。如果没有安装，请先安装 Python：
- 访问 [Python 官网](https://www.python.org/downloads/) 下载并安装
- **重要**：安装时勾选 "Add Python to PATH"

### 第二步：安装项目依赖

1. 打开命令提示符（CMD）或 PowerShell
2. 进入项目目录（假设项目在 `E:\cursor`）：

```bash
cd E:\cursor
```

3. 安装依赖包：

```bash
pip install -r requirements.txt
```

如果安装速度慢，可以使用国内镜像：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 第三步：配置监控文件

有两种方式配置：

#### 方式1：使用图形界面（推荐）

1. 双击运行 `配置管理.bat` 文件
2. 在打开的界面中：
   - 点击"添加映射"按钮
   - 点击"选择文件"选择要监控的源文件
   - 点击"选择目录"选择目标目录
   - 点击"确定"保存
3. 点击"保存配置"按钮

#### 方式2：手动编辑配置文件

1. 用文本编辑器打开 `config.json` 文件
2. 按照以下格式添加配置：

```json
{
  "mappings": [
    {
      "source_file": "E:\\SVN_NEW\\项目名\\Software\\debug\\main.hex",
      "target_dir": "E:\\SVN_NEW\\项目名\\test\\firmware"
    }
  ],
  "settings": {
    "log_file": "sync_log.txt"
  }
}
```

**提示**：可以直接从文件属性中复制路径粘贴到配置文件中，程序会自动处理反斜杠。

### 第四步：启动程序

有两种启动方式：

#### 方式1：使用批处理文件（推荐，隐藏窗口）

双击 `启动文件监控（隐藏窗口）.vbs` 文件，程序将在后台运行。

#### 方式2：使用命令行

打开命令提示符，进入项目目录，运行：

```bash
python main.py
```

程序启动后会在系统托盘（右下角）显示图标。

## 项目分组功能

程序会自动识别项目并分组：

- **自动识别**：根据文件路径自动识别项目，相同父文件夹的映射归为同一项目
- **选择性监控**：可以选择只监控特定项目，节省系统资源
- **一键全选**：可以一键启用/禁用所有项目

### 使用项目分组

1. **在配置界面**：
   - 左侧显示所有识别出的项目
   - 勾选/取消勾选项目来控制是否监控
   - 点击"全选"或"全不选"快速操作
   - 右侧映射列表只显示选中项目的映射

2. **在托盘菜单**：
   - 右键点击托盘图标
   - 选择"项目选择"
   - 可以切换项目启用状态
   - 支持全选/全不选

## 使用方法

### 基本使用流程

1. **配置监控文件**：使用配置界面或手动编辑 `config.json`
2. **启动程序**：双击 `启动文件监控（隐藏窗口）.vbs`
3. **查看状态**：程序在系统托盘运行，右键图标查看菜单
4. **自动同步**：当监控的文件更新时，自动复制到目标目录并打开目录

### 系统托盘菜单

右键点击系统托盘图标，可以访问以下功能：

- **配置管理**：打开图形化配置界面
- **查看日志**：打开日志文件查看操作记录
- **编辑配置**：用记事本打开配置文件
- **刷新配置**：重新加载配置文件（自动应用项目选择变化）
- **项目选择**：切换项目启用/禁用状态
  - 显示所有项目列表
  - 可以单独切换每个项目
  - 支持全选/全不选
- **关于**：显示程序信息
- **退出**：停止监控并退出程序

## 配置文件说明

### 配置文件结构

```json
{
  "mappings": [
    {
      "source_file": "源文件完整路径",
      "target_dir": "目标目录路径"
    }
  ],
  "projects": {
    "项目名称": {
      "enabled": true,
      "mapping_indices": [0, 1]
    }
  },
  "settings": {
    "log_file": "sync_log.txt"
  }
}
```

### 配置项说明

- **mappings**: 文件-目录映射列表
  - **source_file**: 源文件完整路径（需要监控的文件）
  - **target_dir**: 目标目录（文件将被复制到此目录）

- **projects**: 项目分组信息（自动生成，无需手动编辑）
  - **enabled**: 项目是否启用监控
  - **mapping_indices**: 该项目包含的映射索引

- **settings**: 全局设置
  - **log_file**: 日志文件路径（默认：`sync_log.txt`）

## 重要特性

### 文件写入完成检测

程序会等待文件完全写入后再复制，避免复制不完整的文件：
- 检测文件大小稳定性
- 检测文件锁定状态
- 默认等待最多10秒
- 确保文件完整性

### 路径自动处理

- 支持直接粘贴 Windows 路径（如 `E:\SVN_NEW\...`）
- 自动处理反斜杠转义
- 自动规范化路径

## 注意事项

1. **首次使用**：需要先安装 Python 和依赖包
2. **路径配置**：可以直接粘贴 Windows 路径，程序会自动处理
3. **文件权限**：确保有足够的文件系统权限
4. **目标目录**：程序会自动创建目标目录（如果不存在）
5. **文件覆盖**：如果目标目录中已存在同名文件，会被直接覆盖
6. **项目识别**：程序会自动识别项目，相同父文件夹的映射归为同一项目

## 故障排除

### 问题1：提示 "python 不是内部或外部命令"

**原因**：Python 未安装或未添加到 PATH

**解决方法**：
1. 安装 Python（从 [python.org](https://www.python.org/downloads/) 下载）
2. 安装时勾选 "Add Python to PATH"
3. 或手动添加 Python 到系统 PATH

### 问题2：提示 "No module named 'watchdog'"

**原因**：依赖包未安装

**解决方法**：
```bash
pip install -r requirements.txt
```

如果网络慢，使用国内镜像：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 问题3：文件没有被复制

**可能原因**：
1. 配置文件中的路径不正确
2. 源文件目录不存在
3. 文件被长时间锁定（超过10秒）
4. 项目未启用监控

**解决方法**：
1. 检查配置文件中的路径是否正确
2. 查看日志文件 `sync_log.txt` 了解详细错误信息
3. 在配置界面检查项目是否已启用
4. 确保有足够的文件系统权限

### 问题4：程序无法启动

**可能原因**：
1. Python 版本过低
2. 配置文件格式错误
3. 缺少依赖包

**解决方法**：
1. 检查 Python 版本：`python --version`（需要 3.8+）
2. 检查配置文件 JSON 格式是否正确
3. 重新安装依赖：`pip install -r requirements.txt`

### 问题5：看不到托盘图标

**解决方法**：
1. 点击任务栏右下角的向上箭头，展开隐藏的图标
2. 查看日志文件确认程序是否正常运行
3. 检查是否有错误提示

## 项目文件说明

```
file-sync-monitor/
├── main.py                          # 主程序入口
├── file_monitor.py                  # 文件监控核心逻辑
├── config_manager.py                # 配置文件管理
├── config_gui.py                    # 图形化配置界面
├── tray_app.py                      # 系统托盘应用
├── config.json                      # 配置文件（首次运行后生成）
├── requirements.txt                 # Python 依赖列表
├── README.md                        # 使用说明（本文件）
├── 启动文件监控（隐藏窗口）.vbs     # 启动脚本（隐藏窗口）
├── 启动文件监控.bat                 # 启动脚本（显示窗口）
└── 配置管理.bat                     # 配置管理界面启动脚本
```

## 更新日志

### v1.1.0
- ✨ 新增项目分组功能，支持选择性监控
- ✨ 新增图形化配置界面
- 🐛 修复文件写入未完成就复制的致命bug
- ✨ 自动等待文件写入完成后再复制
- ✨ 支持直接粘贴 Windows 路径

### v1.0.0
- 初始版本发布
- 基本文件监控和复制功能

## 许可证

MIT License

## 技术支持

如遇到问题，请：
1. 查看日志文件 `sync_log.txt`
2. 检查配置文件格式
3. 确认 Python 版本和依赖包安装正确
